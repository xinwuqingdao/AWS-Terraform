import { Injectable } from '@angular/core';
import { forkJoin, of } from 'rxjs';
import { concatMap, map } from 'rxjs/operators';
import { EventTypes } from '../public-events/event-types';
import { DEFAULT_CONFIG } from './default-config';
import * as i0 from "@angular/core";
import * as i1 from "../logging/logger.service";
import * as i2 from "../public-events/public-events.service";
import * as i3 from "../storage/storage-persistence.service";
import * as i4 from "./validation/config-validation.service";
import * as i5 from "../utils/platform-provider/platform.provider";
import * as i6 from "./auth-well-known/auth-well-known.service";
import * as i7 from "./loader/config-loader";
class ConfigurationService {
    constructor(loggerService, publicEventsService, storagePersistenceService, configValidationService, platformProvider, authWellKnownService, loader) {
        this.loggerService = loggerService;
        this.publicEventsService = publicEventsService;
        this.storagePersistenceService = storagePersistenceService;
        this.configValidationService = configValidationService;
        this.platformProvider = platformProvider;
        this.authWellKnownService = authWellKnownService;
        this.loader = loader;
        this.configsInternal = {};
    }
    hasManyConfigs() {
        return Object.keys(this.configsInternal).length > 1;
    }
    getAllConfigurations() {
        return Object.values(this.configsInternal);
    }
    getOpenIDConfiguration(configId) {
        if (this.configsAlreadySaved()) {
            return of(this.getConfig(configId));
        }
        return this.getOpenIDConfigurations(configId).pipe(map((result) => result.currentConfig));
    }
    getOpenIDConfigurations(configId) {
        return this.loadConfigs().pipe(concatMap((allConfigs) => this.prepareAndSaveConfigs(allConfigs)), map((allPreparedConfigs) => ({
            allConfigs: allPreparedConfigs,
            currentConfig: this.getConfig(configId),
        })));
    }
    hasAtLeastOneConfig() {
        return Object.keys(this.configsInternal).length > 0;
    }
    saveConfig(readyConfig) {
        const { configId } = readyConfig;
        this.configsInternal[configId] = readyConfig;
    }
    loadConfigs() {
        return this.loader.loadConfigs();
    }
    configsAlreadySaved() {
        return this.hasAtLeastOneConfig();
    }
    getConfig(configId) {
        if (!!configId) {
            return this.configsInternal[configId] || null;
        }
        const [, value] = Object.entries(this.configsInternal)[0] || [[null, null]];
        return value || null;
    }
    prepareAndSaveConfigs(passedConfigs) {
        if (!this.configValidationService.validateConfigs(passedConfigs)) {
            return of(null);
        }
        this.createUniqueIds(passedConfigs);
        const allHandleConfigs$ = passedConfigs.map((x) => this.handleConfig(x));
        return forkJoin(allHandleConfigs$);
    }
    createUniqueIds(passedConfigs) {
        passedConfigs.forEach((config, index) => {
            if (!config.configId) {
                config.configId = `${index}-${config.clientId}`;
            }
        });
    }
    handleConfig(passedConfig) {
        if (!this.configValidationService.validateConfig(passedConfig)) {
            this.loggerService.logError(passedConfig, 'Validation of config rejected with errors. Config is NOT set.');
            return of(null);
        }
        if (!passedConfig.authWellknownEndpointUrl) {
            passedConfig.authWellknownEndpointUrl = passedConfig.authority;
        }
        const usedConfig = this.prepareConfig(passedConfig);
        this.saveConfig(usedConfig);
        const configWithAuthWellKnown = this.enhanceConfigWithWellKnownEndpoint(usedConfig);
        this.publicEventsService.fireEvent(EventTypes.ConfigLoaded, configWithAuthWellKnown);
        return of(usedConfig);
    }
    enhanceConfigWithWellKnownEndpoint(configuration) {
        const alreadyExistingAuthWellKnownEndpoints = this.storagePersistenceService.read('authWellKnownEndPoints', configuration);
        if (!!alreadyExistingAuthWellKnownEndpoints) {
            configuration.authWellknownEndpoints =
                alreadyExistingAuthWellKnownEndpoints;
            return configuration;
        }
        const passedAuthWellKnownEndpoints = configuration.authWellknownEndpoints;
        if (!!passedAuthWellKnownEndpoints) {
            this.authWellKnownService.storeWellKnownEndpoints(configuration, passedAuthWellKnownEndpoints);
            configuration.authWellknownEndpoints = passedAuthWellKnownEndpoints;
            return configuration;
        }
        return configuration;
    }
    prepareConfig(configuration) {
        const openIdConfigurationInternal = { ...DEFAULT_CONFIG, ...configuration };
        this.setSpecialCases(openIdConfigurationInternal);
        return openIdConfigurationInternal;
    }
    setSpecialCases(currentConfig) {
        if (!this.platformProvider.isBrowser()) {
            currentConfig.startCheckSession = false;
            currentConfig.silentRenew = false;
            currentConfig.useRefreshToken = false;
            currentConfig.usePushedAuthorisationRequests = false;
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.0.2", ngImport: i0, type: ConfigurationService, deps: [{ token: i1.LoggerService }, { token: i2.PublicEventsService }, { token: i3.StoragePersistenceService }, { token: i4.ConfigValidationService }, { token: i5.PlatformProvider }, { token: i6.AuthWellKnownService }, { token: i7.StsConfigLoader }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.0.2", ngImport: i0, type: ConfigurationService, providedIn: 'root' }); }
}
export { ConfigurationService };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.0.2", ngImport: i0, type: ConfigurationService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: i1.LoggerService }, { type: i2.PublicEventsService }, { type: i3.StoragePersistenceService }, { type: i4.ConfigValidationService }, { type: i5.PlatformProvider }, { type: i6.AuthWellKnownService }, { type: i7.StsConfigLoader }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlnLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyLWF1dGgtb2lkYy1jbGllbnQvc3JjL2xpYi9jb25maWcvY29uZmlnLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsUUFBUSxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNoRCxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRWhELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUsxRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7Ozs7Ozs7OztBQUtsRCxNQUNhLG9CQUFvQjtJQUcvQixZQUNtQixhQUE0QixFQUM1QixtQkFBd0MsRUFDeEMseUJBQW9ELEVBQ3BELHVCQUFnRCxFQUNoRCxnQkFBa0MsRUFDbEMsb0JBQTBDLEVBQzFDLE1BQXVCO1FBTnZCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFDeEMsOEJBQXlCLEdBQXpCLHlCQUF5QixDQUEyQjtRQUNwRCw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXlCO1FBQ2hELHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQUMxQyxXQUFNLEdBQU4sTUFBTSxDQUFpQjtRQVRsQyxvQkFBZSxHQUF3QyxFQUFFLENBQUM7SUFVL0QsQ0FBQztJQUVKLGNBQWM7UUFDWixPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVELG9CQUFvQjtRQUNsQixPQUFPLE1B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NEIsQ0FDN0IsQ0FBQztZQUNGLGFBQWEsQ0FBQyxzQkFBc0IsR0FBRyw0QkFBNEIsQ0FBQztZQUVwRSxPQUFPLGFBQWEsQ0FBQztTQUN0QjtRQUVELE9BQU8sYUFBYSxDQUFDO0lBQ3ZCLENBQUM7SUFFTyxhQUFhLENBQ25CLGFBQWtDO1FBRWxDLE1BQU0sMkJBQTJCLEdBQUcsRUFBRSxHQUFHLGNBQWMsRUFBRSxHQUFHLGFBQWEsRUFBRSxDQUFDO1FBRTVFLElBQUksQ0FBQyxlQUFlLENBQUMsMkJBQTJCLENBQUMsQ0FBQztRQUVsRCxPQUFPLDJCQUEyQixDQUFDO0lBQ3JDLENBQUM7SUFFTyxlQUFlLENBQUMsYUFBa0M7UUFDeEQsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsRUFBRTtZQUN0QyxhQUFhLENBQUMsaUJBQWlCLEdBQUcsS0FBSyxDQUFDO1lBQ3hDLGFBQWEsQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO1lBQ2xDLGFBQWEsQ0FBQyxlQUFlLEdBQUcsS0FBSyxDQUFDO1lBQ3RDLGFBQWEsQ0FBQyw4QkFBOEIsR0FBRyxLQUFLLENBQUM7U0FDdEQ7SUFDSCxDQUFDOzhHQTNLVSxvQkFBb0I7a0hBQXBCLG9CQUFvQixjQURQLE1BQU07O1NBQ25CLG9CQUFvQjsyRkFBcEIsb0JBQW9CO2tCQURoQyxVQUFVO21CQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZvcmtKb2luLCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY29uY2F0TWFwLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBMb2dnZXJTZXJ2aWNlIH0gZnJvbSAnLi4vbG9nZ2luZy9sb2dnZXIuc2VydmljZSc7XG5pbXBvcnQgeyBFdmVudFR5cGVzIH0gZnJvbSAnLi4vcHVibGljLWV2ZW50cy9ldmVudC10eXBlcyc7XG5pbXBvcnQgeyBQdWJsaWNFdmVudHNTZXJ2aWNlIH0gZnJvbSAnLi4vcHVibGljLWV2ZW50cy9wdWJsaWMtZXZlbnRzLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3RvcmFnZVBlcnNpc3RlbmNlU2VydmljZSB9IGZyb20gJy4uL3N0b3JhZ2Uvc3RvcmFnZS1wZXJzaXN0ZW5jZS5zZXJ2aWNlJztcbmltcG9ydCB7IFBsYXRmb3JtUHJvdmlkZXIgfSBmcm9tICcuLi91dGlscy9wbGF0Zm9ybS1wcm92aWRlci9wbGF0Zm9ybS5wcm92aWRlcic7XG5pbXBvcnQgeyBBdXRoV2VsbEtub3duU2VydmljZSB9IGZyb20gJy4vYXV0aC13ZWxsLWtub3duL2F1dGgtd2VsbC1rbm93bi5zZXJ2aWNlJztcbmltcG9ydCB7IERFRkFVTFRfQ09ORklHIH0gZnJvbSAnLi9kZWZhdWx0LWNvbmZpZyc7XG5pbXBvcnQgeyBTdHNDb25maWdMb2FkZXIgfSBmcm9tICcuL2xvYWRlci9jb25maWctbG9hZGVyJztcbmltcG9ydCB7IE9wZW5JZENvbmZpZ3VyYXRpb24gfSBmcm9tICcuL29wZW5pZC1jb25maWd1cmF0aW9uJztcbmltcG9ydCB7IENvbmZpZ1ZhbGlkYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi92YWxpZGF0aW9uL2NvbmZpZy12YWxpZGF0aW9uLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIENvbmZpZ3VyYXRpb25TZXJ2aWNlIHtcbiAgcHJpdmF0ZSBjb25maWdzSW50ZXJuYWw6IFJlY29yZDxzdHJpbmcsIE9wZW5JZENvbmZpZ3VyYXRpb24+ID0ge307XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBsb2dnZXJTZXJ2aWNlOiBMb2dnZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHVibGljRXZlbnRzU2VydmljZTogUHVibGljRXZlbnRzU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0b3JhZ2VQZXJzaXN0ZW5jZVNlcnZpY2U6IFN0b3JhZ2VQZXJzaXN0ZW5jZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25maWdWYWxpZGF0aW9uU2VydmljZTogQ29uZmlnVmFsaWRhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSBwbGF0Zm9ybVByb3ZpZGVyOiBQbGF0Zm9ybVByb3ZpZGVyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYXV0aFdlbGxLbm93blNlcnZpY2U6IEF1dGhXZWxsS25vd25TZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbG9hZGVyOiBTdHNDb25maWdMb2FkZXJcbiAgKSB7fVxuXG4gIGhhc01hbnlDb25maWdzKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLmNvbmZpZ3NJbnRlcm5hbCkubGVuZ3RoID4gMTtcbiAgfVxuXG4gIGdldEFsbENvbmZpZ3VyYXRpb25zKCk6IE9wZW5JZENvbmZpZ3VyYXRpb25bXSB7XG4gICAgcmV0dXJuIE9iamVjdC52YWx1ZXModGhpcy5jb25maWdzSW50ZXJuYWwpO1xuICB9XG5cbiAgZ2V0T3BlbklEQ29uZmlndXJhdGlvbihjb25maWdJZD86IHN0cmluZyk6IE9ic2VydmFibGU8T3BlbklkQ29uZmlndXJhdGlvbj4ge1xuICAgIGlmICh0aGlzLmNvbmZpZ3NBbHJlYWR5U2F2ZWQoKSkge1xuICAgICAgcmV0dXJuIG9mKHRoaXMuZ2V0Q29uZmlnKGNvbmZpZ0lkKSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuZ2V0T3BlbklEQ29uZmlndXJhdGlvbnMoY29uZmlnSWQpLnBpcGUoXG4gICAgICBtYXAoKHJlc3VsdCkgPT4gcmVzdWx0LmN1cnJlbnRDb25maWcpXG4gICAgKTtcbiAgfVxuXG4gIGdldE9wZW5JRENvbmZpZ3VyYXRpb25zKFxuICAgIGNvbmZpZ0lkPzogc3RyaW5nXG4gICk6IE9ic2VydmFibGU8eyBhbGxDb25maWdzOyBjdXJyZW50Q29uZmlnIH0+IHtcbiAgICByZXR1cm4gdGhpcy5sb2FkQ29uZmlncygpLnBpcGUoXG4gICAgICBjb25jYXRNYXAoKGFsbENvbmZpZ3MpID0+IHRoaXMucHJlcGFyZUFuZFNhdmVDb25maWdzKGFsbENvbmZpZ3MpKSxcbiAgICAgIG1hcCgoYWxsUHJlcGFyZWRDb25maWdzKSA9PiAoe1xuICAgICAgICBhbGxDb25maWdzOiBhbGxQcmVwYXJlZENvbmZpZ3MsXG4gICAgICAgIGN1cnJlbnRDb25maWc6IHRoaXMuZ2V0Q29uZmlnKGNvbmZpZ0lkKSxcbiAgICAgIH0pKVxuICAgICk7XG4gIH1cblxuICBoYXNBdExlYXN0T25lQ29uZmlnKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLmNvbmZpZ3NJbnRlcm5hbCkubGVuZ3RoID4gMDtcbiAgfVxuXG4gIHByaXZhdGUgc2F2ZUNvbmZpZyhyZWFkeUNvbmZpZzogT3BlbklkQ29uZmlndXJhdGlvbik6IHZvaWQge1xuICAgIGNvbnN0IHsgY29uZmlnSWQgfSA9IHJlYWR5Q29uZmlnO1xuXG4gICAgdGhpcy5jb25maWdzSW50ZXJuYWxbY29uZmlnSWRdID0gcmVhZHlDb25maWc7XG4gIH1cblxuICBwcml2YXRlIGxvYWRDb25maWdzKCk6IE9ic2VydmFibGU8T3BlbklkQ29uZmlndXJhdGlvbltdPiB7XG4gICAgcmV0dXJuIHRoaXMubG9hZGVyLmxvYWRDb25maWdzKCk7XG4gIH1cblxuICBwcml2YXRlIGNvbmZpZ3NBbHJlYWR5U2F2ZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuaGFzQXRMZWFzdE9uZUNvbmZpZygpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDb25maWcoY29uZmlnSWQ6IHN0cmluZyk6IE9wZW5JZENvbmZpZ3VyYXRpb24ge1xuICAgIGlmICghIWNvbmZpZ0lkKSB7XG4gICAgICByZXR1cm4gdGhpcy5jb25maWdzSW50ZXJuYWxbY29uZmlnSWRdIHx8IG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgWywgdmFsdWVdID0gT2JqZWN0LmVudHJpZXModGhpcy5jb25maWdzSW50ZXJuYWwpWzBdIHx8IFtbbnVsbCwgbnVsbF1dO1xuXG4gICAgcmV0dXJuIHZhbHVlIHx8IG51bGw7XG4gIH1cblxuICBwcml2YXRlIHByZXBhcmVBbmRTYXZlQ29uZmlncyhcbiAgICBwYXNzZWRDb25maWdzOiBPcGVuSWRDb25maWd1cmF0aW9uW11cbiAgKTogT2JzZXJ2YWJsZTxPcGVuSWRDb25maWd1cmF0aW9uW10+IHtcbiAgICBpZiAoIXRoaXMuY29uZmlnVmFsaWRhdGlvblNlcnZpY2UudmFsaWRhdGVDb25maWdzKHBhc3NlZENvbmZpZ3MpKSB7XG4gICAgICByZXR1cm4gb2YobnVsbCk7XG4gICAgfVxuXG4gICAgdGhpcy5jcmVhdGVVbmlxdWVJZHMocGFzc2VkQ29uZmlncyk7XG4gICAgY29uc3QgYWxsSGFuZGxlQ29uZmlncyQgPSBwYXNzZWRDb25maWdzLm1hcCgoeCkgPT4gdGhpcy5oYW5kbGVDb25maWcoeCkpO1xuXG4gICAgcmV0dXJuIGZvcmtKb2luKGFsbEhhbmRsZUNvbmZpZ3MkKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlVW5pcXVlSWRzKHBhc3NlZENvbmZpZ3M6IE9wZW5JZENvbmZpZ3VyYXRpb25bXSk6IHZvaWQge1xuICAgIHBhc3NlZENvbmZpZ3MuZm9yRWFjaCgoY29uZmlnLCBpbmRleCkgPT4ge1xuICAgICAgaWYgKCFjb25maWcuY29uZmlnSWQpIHtcbiAgICAgICAgY29uZmlnLmNvbmZpZ0lkID0gYCR7aW5kZXh9LSR7Y29uZmlnLmNsaWVudElkfWA7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUNvbmZpZyhcbiAgICBwYXNzZWRDb25maWc6IE9wZW5JZENvbmZpZ3VyYXRpb25cbiAgKTogT2JzZXJ2YWJsZTxPcGVuSWRDb25maWd1cmF0aW9uPiB7XG4gICAgaWYgKCF0aGlzLmNvbmZpZ1ZhbGlkYXRpb25TZXJ2aWNlLnZhbGlkYXRlQ29uZmlnKHBhc3NlZENvbmZpZykpIHtcbiAgICAgIHRoaXMubG9nZ2VyU2VydmljZS5sb2dFcnJvcihcbiAgICAgICAgcGFzc2VkQ29uZmlnLFxuICAgICAgICAnVmFsaWRhdGlvbiBvZiBjb25maWcgcmVqZWN0ZWQgd2l0aCBlcnJvcnMuIENvbmZpZyBpcyBOT1Qgc2V0LidcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiBvZihudWxsKTtcbiAgICB9XG5cbiAgICBpZiAoIXBhc3NlZENvbmZpZy5hdXRoV2VsbGtub3duRW5kcG9pbnRVcmwpIHtcbiAgICAgIHBhc3NlZENvbmZpZy5hdXRoV2VsbGtub3duRW5kcG9pbnRVcmwgPSBwYXNzZWRDb25maWcuYXV0aG9yaXR5O1xuICAgIH1cblxuICAgIGNvbnN0IHVzZWRDb25maWcgPSB0aGlzLnByZXBhcmVDb25maWcocGFzc2VkQ29uZmlnKTtcblxuICAgIHRoaXMuc2F2ZUNvbmZpZyh1c2VkQ29uZmlnKTtcblxuICAgIGNvbnN0IGNvbmZpZ1dpdGhBdXRoV2VsbEtub3duID1cbiAgICAgIHRoaXMuZW5oYW5jZUNvbmZpZ1dpdGhXZWxsS25vd25FbmRwb2ludCh1c2VkQ29uZmlnKTtcblxuICAgIHRoaXMucHVibGljRXZlbnRzU2VydmljZS5maXJlRXZlbnQ8T3BlbklkQ29uZmlndXJhdGlvbj4oXG4gICAgICBFdmVudFR5cGVzLkNvbmZpZ0xvYWRlZCxcbiAgICAgIGNvbmZpZ1dpdGhBdXRoV2VsbEtub3duXG4gICAgKTtcblxuICAgIHJldHVybiBvZih1c2VkQ29uZmlnKTtcbiAgfVxuXG4gIHByaXZhdGUgZW5oYW5jZUNvbmZpZ1dpdGhXZWxsS25vd25FbmRwb2ludChcbiAgICBjb25maWd1cmF0aW9uOiBPcGVuSWRDb25maWd1cmF0aW9uXG4gICk6IE9wZW5JZENvbmZpZ3VyYXRpb24ge1xuICAgIGNvbnN0IGFscmVhZHlFeGlzdGluZ0F1dGhXZWxsS25vd25FbmRwb2ludHMgPVxuICAgICAgdGhpcy5zdG9yYWdlUGVyc2lzdGVuY2VTZXJ2aWNlLnJlYWQoXG4gICAgICAgICdhdXRoV2VsbEtub3duRW5kUG9pbnRzJyxcbiAgICAgICAgY29uZmlndXJhdGlvblxuICAgICAgKTtcblxuICAgIGlmICghIWFscmVhZHlFeGlzdGluZ0F1dGhXZWxsS25vd25FbmRwb2ludHMpIHtcbiAgICAgIGNvbmZpZ3VyYXRpb24uYXV0aFdlbGxrbm93bkVuZHBvaW50cyA9XG4gICAgICAgIGFscmVhZHlFeGlzdGluZ0F1dGhXZWxsS25vd25FbmRwb2ludHM7XG5cbiAgICAgIHJldHVybiBjb25maWd1cmF0aW9uO1xuICAgIH1cblxuICAgIGNvbnN0IHBhc3NlZEF1dGhXZWxsS25vd25FbmRwb2ludHMgPSBjb25maWd1cmF0aW9uLmF1dGhXZWxsa25vd25FbmRwb2ludHM7XG5cbiAgICBpZiAoISFwYXNzZWRBdXRoV2VsbEtub3duRW5kcG9pbnRzKSB7XG4gICAgICB0aGlzLmF1dGhXZWxsS25vd25TZXJ2aWNlLnN0b3JlV2VsbEtub3duRW5kcG9pbnRzKFxuICAgICAgICBjb25maWd1cmF0aW9uLFxuICAgICAgICBwYXNzZWRBdXRoV2VsbEtub3duRW5kcG9pbnRzXG4gICAgICApO1xuICAgICAgY29uZmlndXJhdGlvbi5hdXRoV2VsbGtub3duRW5kcG9pbnRzID0gcGFzc2VkQXV0aFdlbGxLbm93bkVuZHBvaW50cztcblxuICAgICAgcmV0dXJuIGNvbmZpZ3VyYXRpb247XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbmZpZ3VyYXRpb247XG4gIH1cblxuICBwcml2YXRlIHByZXBhcmVDb25maWcoXG4gICAgY29uZmlndXJhdGlvbjogT3BlbklkQ29uZmlndXJhdGlvblxuICApOiBPcGVuSWRDb25maWd1cmF0aW9uIHtcbiAgICBjb25zdCBvcGVuSWRDb25maWd1cmF0aW9uSW50ZXJuYWwgPSB7IC4uLkRFRkFVTFRfQ09ORklHLCAuLi5jb25maWd1cmF0aW9uIH07XG5cbiAgICB0aGlzLnNldFNwZWNpYWxDYXNlcyhvcGVuSWRDb25maWd1cmF0aW9uSW50ZXJuYWwpO1xuXG4gICAgcmV0dXJuIG9wZW5JZENvbmZpZ3VyYXRpb25JbnRlcm5hbDtcbiAgfVxuXG4gIHByaXZhdGUgc2V0U3BlY2lhbENhc2VzKGN1cnJlbnRDb25maWc6IE9wZW5JZENvbmZpZ3VyYXRpb24pOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMucGxhdGZvcm1Qcm92aWRlci5pc0Jyb3dzZXIoKSkge1xuICAgICAgY3VycmVudENvbmZpZy5zdGFydENoZWNrU2Vzc2lvbiA9IGZhbHNlO1xuICAgICAgY3VycmVudENvbmZpZy5zaWxlbnRSZW5ldyA9IGZhbHNlO1xuICAgICAgY3VycmVudENvbmZpZy51c2VSZWZyZXNoVG9rZW4gPSBmYWxzZTtcbiAgICAgIGN1cnJlbnRDb25maWcudXNlUHVzaGVkQXV0aG9yaXNhdGlvblJlcXVlc3RzID0gZmFsc2U7XG4gICAgfVxuICB9XG59XG4iXX0=